pipeline {
  agent any

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    // stage('Build') {
    //   steps {
    //     sh 'npm install'
    //   }
    // }

    // stage('Test') {
    //   steps {
    //     sh 'npm run test:ci'
    //   }
    // }

    stage('Test SSH Connection') {
      steps {
        withCredentials([sshUserPrivateKey(credentialsId: 'SSH_NEWBIE', keyFileVariable: 'SSH_KEY_FILE')]) {
          sh '''
            # Test SSH connection with specific parameters
            EC2_HOST="118.69.34.46"
            EC2_USER="newbie"
            EC2_PORT="3334"

            echo "=== TESTING SSH CONNECTION ==="
            echo "Host: $EC2_HOST"
            echo "User: $EC2_USER"
            echo "Port: $EC2_PORT"
            echo "================================"

            # Test SSH connection
            ssh -i "$SSH_KEY_FILE" -p $EC2_PORT -o StrictHostKeyChecking=no -o ConnectTimeout=10 $EC2_USER@$EC2_HOST "echo 'SSH connection successful!'; whoami; pwd; ls -la"

            echo "=== SSH TEST COMPLETED ==="
          '''
        }
      }
      post {
        success {
          echo 'SSH connection test successful!'
        }
        failure {
          echo 'SSH connection test failed!'
        }
      }
    }

    stage('Deploy to EC2') {
      when {
        branch 'main'
      }
      steps {
        withCredentials([sshUserPrivateKey(credentialsId: 'SSH_NEWBIE', keyFileVariable: 'SSH_KEY_FILE')]) {
          sh '''
            # EC2 server configuration
            EC2_HOST="118.69.34.46"
            EC2_USER="newbie"
            EC2_PORT="3334"
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            DATE_FOLDER=$(date +%Y%m%d)

            echo "=== DEPLOYING TO EC2 ==="
            echo "Host: $EC2_HOST"
            echo "User: $EC2_USER"
            echo "Port: $EC2_PORT"
            echo "Date folder: $DATE_FOLDER"
            echo "========================="

            # Create deployment package with only necessary files
            mkdir -p temp-deploy
            cp index.html temp-deploy/
            cp 404.html temp-deploy/
            cp -r css temp-deploy/
            cp -r js temp-deploy/
            cp -r images temp-deploy/

            # Create tar package
            tar -czf deploy-package.tar.gz -C temp-deploy .

            # Deploy to EC2 server via SSH using key file
            scp -i "$SSH_KEY_FILE" -P $EC2_PORT -o StrictHostKeyChecking=no deploy-package.tar.gz $EC2_USER@$EC2_HOST:/tmp/

            # Execute deployment on EC2 server
            ssh -i "$SSH_KEY_FILE" -p $EC2_PORT -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << EOF
              # Create directory structure
              BASE_DIR="/usr/share/nginx/html/jenkins/tungnguyen"
              PROJECT_DIR="\$BASE_DIR/web-performance-project1-initial"
              DEPLOY_DIR="\$BASE_DIR/deploy"
              VERSION_DIR="\$DEPLOY_DIR/$DATE_FOLDER"
              CURRENT_LINK="\$DEPLOY_DIR/current"

              echo "Creating directories..."
              # Create directories
              mkdir -p "\$PROJECT_DIR"
              mkdir -p "\$VERSION_DIR"

              echo "Extracting files to version directory..."
              # Extract files to version directory
              cd "\$VERSION_DIR"
              tar -xzf /tmp/deploy-package.tar.gz

              echo "Copying files to project directory..."
              # Copy files to project directory
              cp -r * "\$PROJECT_DIR/"

              echo "Creating symlink..."
              # Create symlink to current version
              ln -sfn "\$VERSION_DIR" "\$CURRENT_LINK"

              echo "Cleaning up old versions..."
              # Clean up old versions (keep only 5 latest)
              cd "\$DEPLOY_DIR"
              ls -t | grep -E '^[0-9]{8}$' | tail -n +6 | xargs -r rm -rf

              echo "Cleaning up temp file..."
              # Clean up temp file
              rm -f /tmp/deploy-package.tar.gz

              echo "=== DEPLOYMENT COMPLETED ==="
              echo "Deployed to: \$VERSION_DIR"
              echo "Current symlink: \$CURRENT_LINK"
              echo "Project directory: \$PROJECT_DIR"
              echo "============================="
            EOF

            # Clean up local temp files
            rm -rf temp-deploy
            rm -f deploy-package.tar.gz
          '''
        }
      }
      post {
        success {
          echo 'Deployment to EC2 successful!'
        }
        failure {
          echo 'Deployment to EC2 failed!'
        }
      }
    }
  }
}
