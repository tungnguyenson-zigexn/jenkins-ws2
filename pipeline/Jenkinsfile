pipeline {
  agent any

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build') {
      steps {
        sh 'npm install'
      }
    }

    stage('Test') {
      steps {
        sh 'npm run test:ci'
      }
    }

  //   stage('Deploy to EC2') {
  //     environment {
  //       DEPLOY_SERVER = 'newbie@118.69.34.46'
  //       SSH_PORT = '3334'
  //       DEPLOY_DIR = '/usr/share/nginx/html/jenkins/tungnguyen'
  //       PROJECT_NAME = 'web-performance-project1-initial'
  //     }
  //     steps {
  //       withCredentials([sshUserPrivateKey(credentialsId: 'SSH_NEWBIE', keyFileVariable: 'SSH_KEY_FILE')]) {
  //         sh '''
  //           set -e

  //           echo "==> Starting deployment process..."
  //           echo "==> Server: $DEPLOY_SERVER"
  //           echo "==> Port: $SSH_PORT"
  //           echo "==> Deploy directory: $DEPLOY_DIR"

  //           # Validate SSH key file
  //           if [[ ! -f "$SSH_KEY_FILE" ]]; then
  //             echo "‚ùå SSH key file not found: $SSH_KEY_FILE"
  //             exit 1
  //           fi

  //           # Test SSH connection
  //           echo "==> Testing SSH connection..."
  //           if ! ssh -i "$SSH_KEY_FILE" -p $SSH_PORT -o ConnectTimeout=10 -o StrictHostKeyChecking=no $DEPLOY_SERVER "echo 'SSH connection successful'" >/dev/null 2>&1; then
  //             echo "‚ùå Cannot connect to server: $DEPLOY_SERVER"
  //             exit 1
  //           fi
  //           echo "‚úÖ SSH connection verified"

  //           # Change to workspace directory
  //           echo "==> Change to workspace: $WORKSPACE"
  //           cd "$WORKSPACE"

  //           # Create directory on server
  //           echo "==> Creating directory on server..."
  //           ssh -i "$SSH_KEY_FILE" -p $SSH_PORT -o StrictHostKeyChecking=no $DEPLOY_SERVER "
  //             mkdir -p $DEPLOY_DIR
  //             echo 'Directory created successfully'
  //           "

  //           # Generate timestamp for deployment
  //           TIMESTAMP=$(date +%Y%m%d%H%M%S)
  //           echo "==> Deployment timestamp: $TIMESTAMP"

  //           # Create deploy directory with timestamp
  //           echo "==> Creating deploy directory with timestamp on server..."
  //           ssh -i "$SSH_KEY_FILE" -p $SSH_PORT -o StrictHostKeyChecking=no $DEPLOY_SERVER "
  //             mkdir -p $DEPLOY_DIR/$PROJECT_NAME/deploy/$TIMESTAMP
  //             echo 'Deploy directory created successfully: deploy/$TIMESTAMP'
  //           "

  //           # Upload index.html to timestamped directory
  //           echo "==> Uploading index.html to server..."
  //           scp -i "$SSH_KEY_FILE" -P $SSH_PORT index.html $DEPLOY_SERVER:$DEPLOY_DIR/$PROJECT_NAME/deploy/$TIMESTAMP/
  //           echo "‚úÖ index.html uploaded successfully"

  //           # Create symlink to current deployment (Capistrano style)
  //           echo "==> Creating symlink to current deployment..."
  //           ssh -i "$SSH_KEY_FILE" -p $SSH_PORT -o StrictHostKeyChecking=no $DEPLOY_SERVER "
  //             cd $DEPLOY_DIR/$PROJECT_NAME/deploy
  //             ln -sfn $TIMESTAMP current
  //             echo 'Symlink created: current -> $TIMESTAMP'
  //           "

  //           # Cleanup old deployments (keep only 5 latest versions)
  //           echo "==> Cleaning up old deployments (keeping 5 latest versions)..."
  //           ssh -i "$SSH_KEY_FILE" -p $SSH_PORT -o StrictHostKeyChecking=no $DEPLOY_SERVER "
  //             cd $DEPLOY_DIR/$PROJECT_NAME/deploy && ls -1t | grep -v '^current$' | tail -n +6 | xargs -r rm -rf

  //             echo \"‚úÖ Cleanup completed. Kept 5 latest versions.\"
  //           "

  //           echo "üéâ Deployment completed successfully!"
  //         '''
  //       }
  //     }
  //   }

  post {
    success {
      withCredentials([string(credentialsId: 'SLACK_KEY', variable: 'SLACK_WEBHOOK')]) {
        script {
          def message = "‚úÖ Deployment Successful - Build ${env.BUILD_NUMBER}"
          sh "curl -X POST -H 'Content-type: application/json' --data '{\"text\":\"${message}\"}' '${SLACK_WEBHOOK}'"
        }
      }
    }
    failure {
      withCredentials([string(credentialsId: 'SLACK_KEY', variable: 'SLACK_WEBHOOK')]) {
        script {
          def message = "‚ùå Deployment Failed - Build ${env.BUILD_NUMBER}"
          sh "curl -X POST -H 'Content-type: application/json' --data '{\"text\":\"${message}\"}' '${SLACK_WEBHOOK}'"
        }
      }
    }
  }
}
